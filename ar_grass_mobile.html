<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR.js — Grass on Marker (Standalone)</title>
  <style>html,body{margin:0;height:100%;overflow:hidden;background:#000}#info{position:absolute;top:8px;width:100%;text-align:center;z-index:2;color:#fff;font-family:monospace}</style>

  <!-- three.js (from official three.js CDN) and AR.js build (jeromeetienne repo) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://jeromeetienne.github.io/AR.js/three.js/build/ar.js"></script>
</head>
<body>
  <div id="info">Point the camera at the <strong>patt.hiro</strong> marker. Allow camera access.</div>

<script>
// ---- Configuration: use absolute URLs for camera parameters and pattern file ----
THREEx = window.THREEx || {};
THREEx.ArToolkitContext = THREEx.ArToolkitContext || window.ARToolkit && window.ARToolkit.Context ? window.ARToolkit.Context : THREEx.ArToolkitContext;

var CAMERA_PARAM_URL = 'https://jeromeetienne.github.io/AR.js/three.js/data/data/camera_para.dat';
var PATTERN_URL = 'https://jeromeetienne.github.io/AR.js/three.js/data/data/patt.hiro';

////////////////////////////////////////////////////////////////////////////////
// Renderer / scene / camera
////////////////////////////////////////////////////////////////////////////////
var renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.domElement.style.position = 'absolute';
renderer.domElement.style.top = '0px';
document.body.appendChild(renderer.domElement);

var scene = new THREE.Scene();
var camera = new THREE.Camera();
scene.add(camera);

// lights for shading
var ambient = new THREE.AmbientLight(0xffffff, 0.6);
scene.add(ambient);
var dir = new THREE.DirectionalLight(0xffffff, 0.6);
dir.position.set(1,2,1).normalize();
scene.add(dir);

var onRenderFcts = [];

////////////////////////////////////////////////////////////////////////////////
// arToolkitSource (webcam)
////////////////////////////////////////////////////////////////////////////////
var arToolkitSource = new THREEx.ArToolkitSource({ sourceType: 'webcam' });

arToolkitSource.init(function onReady(){
  onResize();
});

window.addEventListener('resize', function(){ onResize(); });
function onResize(){
  arToolkitSource.onResizeElement();
  arToolkitSource.copyElementSizeTo(renderer.domElement);
  if( arToolkitContext && arToolkitContext.arController ){
    arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
  }
}

////////////////////////////////////////////////////////////////////////////////
// arToolkitContext
////////////////////////////////////////////////////////////////////////////////
var arToolkitContext = new THREEx.ArToolkitContext({
  cameraParametersUrl: CAMERA_PARAM_URL,
  detectionMode: 'mono',
  maxDetectionRate: 30,
  canvasWidth: 800,
  canvasHeight: 600,
});

arToolkitContext.init(function(){
  camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
});

onRenderFcts.push(function(){
  if( arToolkitSource.ready === false ) return;
  arToolkitContext.update(arToolkitSource.domElement);
});

////////////////////////////////////////////////////////////////////////////////
// Marker controls + smoothing
////////////////////////////////////////////////////////////////////////////////
var markerRoot = new THREE.Group();
scene.add(markerRoot);

var markerControls = new THREEx.ArMarkerControls(arToolkitContext, markerRoot, {
  type: 'pattern',
  patternUrl: PATTERN_URL,
  // change size if you want a different scale
});

// Smoothed controls (optional) — included in many AR.js examples; if not available it's harmless
if(THREEx.ArSmoothedControls){
  var smoothedRoot = new THREE.Group();
  scene.add(smoothedRoot);
  var smoothedControls = new THREEx.ArSmoothedControls(smoothedRoot, {
    lerpPosition: 0.4,
    lerpQuaternion: 0.3,
    lerpScale: 1,
  });
  onRenderFcts.push(function(delta){ smoothedControls.update(markerRoot); });
} else {
  // fallback: use markerRoot directly
  var smoothedRoot = markerRoot;
}

var arWorldRoot = smoothedRoot;

////////////////////////////////////////////////////////////////////////////////
// Create ground + grass (non-transparent green ground and many small triangular blades)
////////////////////////////////////////////////////////////////////////////////
// Ground: a square plane that sits flush on the marker (top surface at y=0)
var groundSize = 1.6; // meters relative to marker size
var groundGeo = new THREE.PlaneGeometry(groundSize, groundSize);
var groundMat = new THREE.MeshLambertMaterial({color: 0x1b7a1b, side: THREE.DoubleSide});
var groundMesh = new THREE.Mesh(groundGeo, groundMat);
groundMesh.rotation.x = -Math.PI/2; // make it horizontal (XZ plane)
groundMesh.position.y = 0; // top surface at marker plane
arWorldRoot.add(groundMesh);

// Slightly raise the ground's top so blades originate above marker surface (prevent z-fighting)
var grassBaseY = 0.001;

// Grass blade prototype geometry (triangular cone -> ConeGeometry with radialSegments=3)
function createGrassBlade(){
  var height = 0.08 + Math.random()*0.12; // 8cm-20cm (relative scale)
  var radius = 0.006 + Math.random()*0.01; // thin base
  var geo = new THREE.ConeGeometry(radius, height, 3);
  // shift geometry so base is at y=0
  geo.translate(0, height/2, 0);
  var mat = new THREE.MeshLambertMaterial({color: 0x2aa02a});
  var mesh = new THREE.Mesh(geo, mat);
  return mesh;
}

// Scatter many blades on the ground
var bladesCount = 260;
for(var i=0;i<bladesCount;i++){
  var blade = createGrassBlade();
  // random position within ground square (avoid edges a little)
  var margin = 0.02;
  var x = (Math.random()* (groundSize - margin*2) - (groundSize/2 - margin));
  var z = (Math.random()* (groundSize - margin*2) - (groundSize/2 - margin));
  blade.position.x = x;
  blade.position.z = z;
  blade.position.y = grassBaseY;
  // slight random tilt
  blade.rotation.x = (Math.random()-0.5)*0.25;
  blade.rotation.z = (Math.random()-0.5)*0.4;
  // small scale variation
  var s = 0.8 + Math.random()*0.6;
  blade.scale.set(s,s,s);
  arWorldRoot.add(blade);
}

////////////////////////////////////////////////////////////////////////////////
// Optional: add a subtle rotating decorative object so you can see animation
////////////////////////////////////////////////////////////////////////////////
var decoGeo = new THREE.TorusKnotGeometry(0.18,0.05,64,16);
var decoMat = new THREE.MeshNormalMaterial();
var deco = new THREE.Mesh(decoGeo, decoMat);
deco.position.y = 0.3;
arWorldRoot.add(deco);
onRenderFcts.push(function(delta){ deco.rotation.x += 0.6 * delta; deco.rotation.y += 0.4 * delta; });

////////////////////////////////////////////////////////////////////////////////
// Render loop
////////////////////////////////////////////////////////////////////////////////
var lastTimeMsec = null;
requestAnimationFrame(function animate(nowMsec){
  requestAnimationFrame(animate);
  lastTimeMsec = lastTimeMsec || nowMsec-1000/60;
  var deltaMsec = Math.min(200, nowMsec - lastTimeMsec);
  lastTimeMsec = nowMsec;
  onRenderFcts.forEach(function(onRenderFct){ onRenderFct(deltaMsec/1000, nowMsec/1000); });
  renderer.render(scene, camera);
});

// Helpful note: show a simple onscreen FPS using Stats if you want (uncomment below)
// var script = document.createElement('script'); script.src = 'https://jeromeetienne.github.io/AR.js/three.js/examples/vendor/three.js/examples/js/libs/stats.min.js'; document.body.appendChild(script);
</script>
</body>
</html>
